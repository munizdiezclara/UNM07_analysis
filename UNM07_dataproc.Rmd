---
title: "UNM07_dataproc"
output: pdf_document
date: "2023-09-13"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(afex)
library(BayesFactor)
library(apa)
library(emmeans)
library("writexl")
```
The important columns that need to be taken in all data files are "participant", "session", "age" and "gender".

Training data start in row 10 of excel, but the length varies depending on the time outs. The important columns here are: 
"cue_img", (what images are each cue, basically the randomization of the images for that participant)
"cue_order",
"out_order",
"cue_o_mouse.time", (basically the reaction time)
"cue_o_mouse.clicked_name", (which outcome they have clicked)
"correct_answer", (1 if they clicked the outcome programmed, 0 if they clicked the other)
"training_trials.thisN", (trial number)
"cue1",
"cue2",
"outcome"

Test data start depends on where the training ends. The important columns here are:
"test_mouse.time",
"test_mouse.clicked_name",
"slider.response" ,
"slider.rt",
"test.thisTrialN", (trial number)
"target"

```{r, include=FALSE}
#read in the files and select the important information on them
csv_files <- list.files("data", full.names = TRUE, pattern = ".csv")  # needed for reading data
check_with_demo <-  NULL
for (subj in 1:length(csv_files)) {
  pData <- read_csv(csv_files[subj], col_names = TRUE) #read in the csv files
  p_check_with_demo <-pData[1,]
  p_check_with_demo <- select(p_check_with_demo, c("participant", "age", "gender", "condition"))
  check_with_demo <- rbind(check_with_demo, p_check_with_demo)
}
write_xlsx(check_with_demo, "check.xlsx")
```
```{r, include=FALSE}
comp1 <- NULL
for (subj in 1:length(csv_files)) {
  pData <- read_csv(csv_files[subj], col_names = TRUE) #read in the csv files
  p_comp1 <- select(pData, c("participant", "age", "gender", "comp1_mouse.clicked_name" ))
  p_comp1 <- p_comp1[complete.cases(p_comp1$comp1_mouse.clicked_name),]
  comp1 <- rbind(comp1, p_comp1)
}
comp3 <- NULL
for (subj in 1:length(csv_files)) {
  pData <- read_csv(csv_files[subj], col_names = TRUE) #read in the csv files
  p_comp3 <- select(pData, c("participant", "age", "gender", "comp3_mouse.clicked_name" ))
  p_comp3 <- p_comp3[complete.cases(p_comp3$comp3_mouse.clicked_name),]
  comp3 <- rbind(comp3, p_comp3)
}
comp1_notpassed <- comp1[comp1$comp1_mouse.clicked_name != "comp1_resp1", ]
comp3_notpassed <- comp3[comp3$comp3_mouse.clicked_name != "comp3_resp1", ]
not_passed <- comp3_notpassed$participant
```

```{r, include=FALSE}
training <- NULL #create an empty data file to put the results of the loop
test <- NULL #create an empty data file to put the results of the loop
for (subj in 1:length(csv_files)) {
  pData <- read_csv(csv_files[subj], col_names = TRUE) #read in the csv files
  pTraining1 <- select(pData, c("participant",
                               "condition",
                               "age",
                               "gender",
                               "training_trials.thisN", 
                               "cue1", 
                               "cue2", 
                               "outcome")) #select the important columns
  pTraining1 <- pTraining1[complete.cases(pTraining1$training_trials.thisN),]#this selects the rows with information on them 
  pTraining2 <- select(pData, c("cue_o_mouse.clicked_name",
                               "correct_answer",
                               "cue_o_mouse.time", 
                               "cue_order", 
                               "out_order")) #select the important columns
  pTraining2 <- pTraining2[complete.cases(pTraining2$cue_order),]
  pTraining <- cbind(pTraining1,pTraining2)
  pTraining <- pTraining %>%
    mutate(block = rep(1:4, each = 20), .after = gender)
  training <-  rbind (training, pTraining) #add the results to training
  pTest <- select(pData, c("participant",
                           "condition",
                           "age",
                           "gender",
                           "target",
                           "distractor_test2",
                           "mouse_test2_vsubtle.clicked_name",
                           "mouse_test2_vsubtle.time",
                           "slider_test2_vsubtle.response",
                           "slider_test2_vsubtle.rt"))
  pTest <- pTest[complete.cases(pTest$distractor_test2),]
  test <-  rbind (test, pTest) #add the results to training
}
```

```{r, include=FALSE}
#change variable names to make them coincide
test <- test %>%
  rename("test_choice" = "mouse_test2_vsubtle.clicked_name",
         "test_choice_time" = "mouse_test2_vsubtle.time",
         "test_rating" = "slider_test2_vsubtle.response",
         "test_rating_RT" = "slider_test2_vsubtle.rt",
         "distractor" = "distractor_test2")
```

```{r, include=FALSE}
#create and save files
training <- training %>% #add pNum
  mutate(pNum = rep(c(1:(nrow(training)/80)), each = 80), .after = participant) %>%
  mutate(condition = case_when(condition == 1 ~ "Certain",
                               condition == 2 ~ "Uncertain"))
test <- test %>%
  mutate(pNum = rep(c(1:(nrow(test)/24)), each = 24), .after = participant)%>%
  mutate(acc = case_when(test_choice == "target_test2_vsubtle"~ 1,
                         test_choice == "target_test2_subtle" ~ 1,
                         test_choice == "target_test2_nosubtle" ~ 1,
                         test_choice == "distractor_test2_vsubtle" ~ 0,
                         test_choice == "distractor_test2_subtle" ~ 0,
                         test_choice == "distractor_test2_nosubtle" ~ 0)
         , .after = distractor) %>%
  mutate(test_rating = ifelse(is.na(test_rating), 5.5, test_rating)) %>%
  mutate(mem_score = case_when(acc == 1 ~ (1*test_rating), acc == 0 ~ (-1*test_rating)), .after = acc) %>%
  mutate(c_mem_score = case_when(acc == 1 ~ (1*test_rating), acc == 0 ~ (0*test_rating)), .after = mem_score) %>%
  mutate(predictiveness = case_when(target %in% c(1:4) ~ "predictive", 
                                      target %in% c(5:8) ~ "non-predictive")) %>%
  mutate(cue_type = case_when(condition == 1 & predictiveness == "predictive" ~ "C_P", 
                              condition == 2 & predictiveness == "predictive" ~ "U_P",
                              condition == 1 & predictiveness == "non-predictive" ~ "C_NP", 
                              condition == 2 & predictiveness == "non-predictive" ~ "U_NP")) %>%
  mutate(condition = case_when(condition == 1 ~ "Certain",
                               condition == 2 ~ "Uncertain"))
```


```{r, include=FALSE}
save(training, test, not_passed, file = "UNM06_proc_data.RData")
```

